- name: "Create bucket"
  s3_bucket:
    name: "{{ item.name }}"
    state: present
  loop: "{{ triggers.buckets }}"
  loop_control:
    label: "{{ item.name }}"


- name: "Create dictionaries"
  amazon.aws.s3_object:
    bucket: "{{ item.0.name }}"
    object: "{{ item.1.directory }}"
    mode: create
    region: "{{ region }}"
  loop_control:
    label: "s3://{{ item.0.name }}/{{ item.1.directory }}"
  loop: "{{ triggers.buckets|subelements('notifications') }}"


#- name: "Create S3 Trigger"
#  community.aws.s3_bucket_notification:
#    state: present
#    event_name: "{{ item.1.name }}"
#    bucket_name: "{{ item.0.name }}"
#    queue_arn: "arn:aws:sqs:{{ region }}:{{ aws.account }}:{{ item.1.queue }}"
#    events: ["s3:ObjectCreated:*"]
#    prefix: "{{ item.directory }}"
#  loop_control:
#    label: "{{ item.1.name }}: {{ item.0.name }}/{{ item.1.directory }} -> {{ item.1.queue }}"
#  loop: "{{ triggers.buckets }}"


- name: "S3 notification file"
  template:
    src: "s3-notification.json.j2"
    dest: "/tmp/s3-{{ item.name }}-notification.json"
  loop: "{{ triggers.buckets }}"
  loop_control:
    label: "{{ item.name }}"


- name: "Apply S3 triggers"
  shell: "aws s3api put-bucket-notification-configuration --bucket={{ item.name }} --cli-input-json file:///tmp/s3-{{ item.name }}-notification.json"
  loop: "{{ triggers.buckets }}"
  loop_control:
    label: "{{ item.name }}"
